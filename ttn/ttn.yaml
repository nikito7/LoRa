# Home Assistant Package
# ttn
# Bridge:
# - mqtt to mqtt
# - v3 to home/v3

### ### ###

mqtt:
#2
  sensor:
###4
    - name: "EB5 LoRa Counter"
      unique_id: EB5_LoRa_Counter
      state_topic: "home/v3/nikito-app@ttn/devices/eui-70b3d57ed00617fe/up"
      value_template: >
        {% if value_json.uplink_message is defined %}
          {{ value_json.uplink_message.f_cnt }}
        {% endif %}
      state_class: measurement
###4
    - name: "EB5 LoRa rssi"
      unique_id: EB5_LoRa_rssi
      state_topic: "home/v3/nikito-app@ttn/devices/eui-70b3d57ed00617fe/up"
      value_template: >
        {% if value_json.uplink_message is defined %}
        {% set x = value_json.uplink_message.rx_metadata.0.rssi %}
          {{ x }}
        {% endif %}
      state_class: measurement
      device_class: signal_strength
      unit_of_measurement: dBm

########### HAN ###########
###4
    - name: "EB5 Clock"
      unique_id: EB5_Clock
      state_topic: "home/v3/nikito-app@ttn/devices/eui-70b3d57ed00617fe/up"
      value_template: >
        {% if value_json.uplink_message is defined %}
          {% if value_json.uplink_message.decoded_payload is defined %}
            {% if value_json.uplink_message.decoded_payload.Clock is defined %}
              {{ value_json.uplink_message.decoded_payload.Clock|string }}
            {% endif %}          
          {% endif %}
        {% endif %}
      icon: mdi:clock
      device:
        identifiers: nikito7-EB5
###4
    - name: "EB5 Voltage L1"
      unique_id: EB5_VolL1
      state_topic: "home/v3/nikito-app@ttn/devices/eui-70b3d57ed00617fe/up"
      value_template: >
        {% if value_json.uplink_message.decoded_payload.VL1 is defined %}
          {% set x = value_json.uplink_message.decoded_payload.VL1|float(0) %}
          {% if x > 0 %}
            {{ x }}
          {% endif %}
        {% endif %}
      unit_of_measurement: "V"
      device_class: voltage
      state_class: measurement
      device:
        identifiers: nikito7-EB5
###4
    - name: "EB5 Current L1"
      unique_id: EB5_CurL1
      state_topic: "home/v3/nikito-app@ttn/devices/eui-70b3d57ed00617fe/up"
      value_template: >
        {% if value_json.uplink_message.decoded_payload.CL1 is defined %}
          {{ value_json.uplink_message.decoded_payload.CL1|float(0.0) }}
        {% endif %}
      unit_of_measurement: "A"
      device_class: current
      state_class: measurement
      device:
        identifiers: nikito7-EB5
# EOF
