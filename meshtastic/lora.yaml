# Home Assistant Package
# Meshtastic
# Bridge:
# - mqtt to mqtt
# - msh to home/msh

mqtt:
#2
  sensor:
###4
    - name: "LoRa GW1 Pressure"
      unique_id: LoRa_GW1_Pres3
      state_topic: "home/msh/2/json/LongFast/!1fe9fc00"
      value_template: >
        {% set from = value_json.from|string %}
        {% set x = value_json.payload.barometric_pressure|round(1)|float(None) %}
        {% if x > 0 and from == "360003796" %}
          {{ x }}
        {% else %}
          {{ states('sensor.lora_gw1_pressure') }}
        {% endif %}
      state_class: measurement
      device_class: pressure
      unit_of_measurement: hPa

    - name: "LoRa GW1 Temperature"
      unique_id: LoRa_GW1_Temp3
      state_topic: "home/msh/2/json/LongFast/!1fe9fc00"
      value_template: >
        {% set from = value_json.from|string %}
        {% set x = value_json.payload.temperature|round(1)|float(None) %}
        {% if x > -50 and from == "360003796" %}
          {{ x }}
        {% else %}
          {{ states('sensor.lora_gw1_temperature') }}
        {% endif %}
      state_class: measurement
      device_class: temperature
      unit_of_measurement: "Â°C"

### ### ###

    - name: "LoRa Sensor Soil ID"
      unique_id: LoRa_Sensor_Soil_ID
      state_topic: "home/msh/2/json/PublicData/!1fe9fc00"
      value_template: >
        {% set id = value_json.payload.id|string %}
        {% if id == "sensor_soil" %}
          {{ id }}
        {% endif %}
      icon: "mdi:identifier"
      
    - name: "LoRa Sensor Soil Temperature"
      unique_id: LoRa_Sensor_Soil_Temp3
      state_topic: "home/msh/2/json/PublicData/!1fe9fc00"
      value_template: >
        {% set id = value_json.payload.id %}
        {% set x = value_json.payload.t|round(1)|float(None) %}
        {% if id == "sensor_soil" and x > -99 and x < 100 %}
          {{ x }}
        {% else %}
          {{ states('sensor.lora_sensor_soil_temperature') }}
        {% endif %}
      state_class: measurement
      device_class: temperature
      unit_of_measurement: "Â°C"

    - name: "LoRa Sensor Soil Humidity"
      unique_id: LoRa_Sensor_Soil_Hum3
      state_topic: "home/msh/2/json/PublicData/!1fe9fc00"
      value_template: >
        {% if is_defined value_json.payload %}
          {% set id = value_json.payload.id %}
          {% set x = value_json.payload.h|int(None) %}
          {% if id == "sensor_soil" and x > -1 and x < 101 %}
            {{ x }}
          {% else %}
            {{ states('sensor.lora_sensor_soil_humidity') }}
          {% endif %}
        {% endif %}
      state_class: measurement
      device_class: humidity
      unit_of_measurement: "%"

# EOF

